<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JB Transport Service - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-container h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
            font-size: 24px;
        }

        .login-container p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: 'Sarabun', sans-serif;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            font-family: 'Sarabun', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .header-info {
            text-align: right;
        }

        .header-info span {
            display: block;
            color: #666;
            font-size: 14px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .controls-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .controls-row .form-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-free {
            background: #d4edda;
            color: #155724;
        }

        .status-charging {
            background: #fff3cd;
            color: #856404;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .hidden {
            display: none;
        }

        .cold-indicator {
            color: #17a2b8;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .sync-status {
            display: inline-block;
            padding: 5px 10px;
            background: #d4edda;
            color: #155724;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-info {
                text-align: center;
                margin-top: 10px;
            }

            .controls-row {
                flex-direction: column;
            }

            .controls-row .form-group {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <h1>üöõ JB Transport Service</h1>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</p>
        <div class="form-group">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
            <input type="text" id="loginUsername" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
        </div>
        <div class="form-group">
            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <input type="password" id="loginPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
        </div>
        <button class="btn" onclick="login()" id="loginBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="main-container" id="mainApp">
        <div class="header">
            <div>
                <h1>üöõ JB Transport Service</h1>
                <p style="color: #666; margin-top: 5px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå <span class="sync-status" id="syncStatus">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...</span></p>
            </div>
            <div class="header-info">
                <span id="currentUser" style="font-weight: 600; color: #667eea;"></span>
                <span id="currentDate"></span>
                <button class="btn btn-secondary btn-small" onclick="logout()" style="margin-top: 10px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="stat-card">
                <h3>‡∏ï‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div class="value" id="totalContainers">0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö</h3>
                <div class="value" id="freeContainers" style="color: #28a745;">0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h3>
                <div class="value" id="chargingContainers" style="color: #ffc107;">0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</h3>
                <div class="value" id="totalRevenue" style="color: #667eea;">‡∏ø0</div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-row">
                <div class="form-group">
                    <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ï‡∏π‡πâ</label>
                    <input type="text" id="searchContainer" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå" oninput="filterContainers()">
                </div>
                <div class="form-group">
                    <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î</label>
                    <select id="filterSize" onchange="filterContainers()">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î</option>
                        <option value="20">20 ‡∏ü‡∏∏‡∏ï</option>
                        <option value="40">40 ‡∏ü‡∏∏‡∏ï</option>
                        <option value="45">45 ‡∏ü‡∏∏‡∏ï</option>
                        <option value="40R">40 ‡∏ü‡∏∏‡∏ï (‡πÄ‡∏¢‡πá‡∏ô)</option>
                        <option value="45R">45 ‡∏ü‡∏∏‡∏ï (‡πÄ‡∏¢‡πá‡∏ô)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <select id="filterType" onchange="filterContainers()">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                        <option value="Normal">‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
                        <option value="R">‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô (R)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="filterStatus" onchange="filterContainers()">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                        <option value="free">‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö</option>
                        <option value="charging">‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö</option>
                        <option value="overdue">‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ß‡∏±‡∏ô</option>
                    </select>
                </div>
            </div>
            <div class="controls-row" style="margin-top: 15px;">
                <button class="btn btn-success btn-small" onclick="openAddModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</button>
                <button class="btn btn-small" onclick="exportToCSV()">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV</button>
            </div>
        </div>

        <div class="table-container">
            <div id="loadingIndicator" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            <table id="containerTableElement" style="display: none;">
                <thead>
                    <tr>
                        <th>‡πÄ‡∏•‡∏Ç‡∏ï‡∏π‡πâ</th>
                        <th>‡∏Ç‡∏ô‡∏≤‡∏î</th>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö</th>
                        <th>‡∏ü‡∏£‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        <th>‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="containerTable"></tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="containerModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</h2>
            <form onsubmit="saveContainer(event)">
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏Ç‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå *</label>
                    <input type="text" id="containerNo" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ABCU1234567">
                </div>
                <div class="form-group">
                    <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏π‡πâ *</label>
                    <select id="containerSize" required>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î</option>
                        <option value="20">20 ‡∏ü‡∏∏‡∏ï</option>
                        <option value="40">40 ‡∏ü‡∏∏‡∏ï</option>
                        <option value="45">45 ‡∏ü‡∏∏‡∏ï</option>
                        <option value="40R">40 ‡∏ü‡∏∏‡∏ï (‡πÄ‡∏¢‡πá‡∏ô)</option>
                        <option value="45R">45 ‡∏ü‡∏∏‡∏ï (‡πÄ‡∏¢‡πá‡∏ô)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label>
                    <select id="containerType" required>
                        <option value="Normal">‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
                        <option value="R">‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô (R) ‚ùÑÔ∏è</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ *</label>
                    <input type="datetime-local" id="dateTimeIn" required>
                </div>
                <div class="form-group">
                    <label>‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö (‡∏ß‡∏±‡∏ô)</label>
                    <input type="number" id="freeDays" value="5" readonly>
                </div>
                <div class="form-group">
                    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="notes" rows="3" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©..."></textarea>
                </div>
                <button type="submit" class="btn" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARRWLc-UfDrnFCGnJLA7vAHMzMjPWUark",
            authDomain: "jbts-2026.firebaseapp.com",
            projectId: "jbts-2026",
            storageBucket: "jbts-2026.firebasestorage.app",
            messagingSenderId: "1073142548606",
            appId: "1:1073142548606:web:2c7ae432661a06ed47b02f",
            measurementId: "G-1LYXK7HE6P",
            databaseURL: "https://jbts-2026-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let containers = {};
        let currentUser = null;
        let editingKey = null;

        window.login = login;
        window.logout = logout;
        window.openAddModal = openAddModal;
        window.closeModal = closeModal;
        window.saveContainer = saveContainer;
        window.filterContainers = filterContainers;
        window.checkOut = checkOut;
        window.deleteContainer = deleteContainer;
        window.exportToCSV = exportToCSV;

        function loadContainers() {
            const containersRef = ref(database, 'containers');
            onValue(containersRef, (snapshot) => {
                containers = snapshot.val() || {};
                renderContainers();
                updateStats();
                updateSyncStatus(true);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('containerTableElement').style.display = 'table';
            }, (error) => {
                console.error('Firebase error:', error);
                updateSyncStatus(false);
            });
        }

        function updateSyncStatus(success) {
            const status = document.getElementById('syncStatus');
            if (success) {
                status.textContent = '‚úì ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß';
                status.style.background = '#d4edda';
                status.style.color = '#155724';
            } else {
                status.textContent = '‚úó ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
                status.style.background = '#f8d7da';
                status.style.color = '#721c24';
            }
        }

        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');

            if (username === 'JBTS' && password === 'JBTS2011') {
                loginBtn.disabled = true;
                loginBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
                currentUser = username;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUser').textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${username}`;
                updateCurrentDate();
                loadContainers();
                loginBtn.disabled = false;
                loginBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            } else {
                alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
            }
        }

        function logout() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            }
        }

        function updateCurrentDate() {
            const now = new Date();
            const thaiMonths = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
            const dateStr = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')} ‡∏ô.`;
            document.getElementById('currentDate').textContent = dateStr;
        }

        setInterval(updateCurrentDate, 60000);

        function openAddModal() {
            editingKey = null;
            document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('containerNo').value = '';
            document.getElementById('containerSize').value = '';
            document.getElementById('containerType').value = 'Normal';
            document.getElementById('freeDays').value = '5';
            document.getElementById('notes').value = '';
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('dateTimeIn').value = now.toISOString().slice(0, 16);
            document.getElementById('containerModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('containerModal').style.display = 'none';
        }

        async function saveContainer(e) {
            e.preventDefault();
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const containerNo = document.getElementById('containerNo').value.toUpperCase();
            const isDuplicate = Object.values(containers).some(c => 
                c.containerNo === containerNo && (!editingKey || Object.keys(containers).find(k => containers[k].containerNo === containerNo) !== editingKey)
            );
            
            if (isDuplicate) {
                alert('‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ï‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß!');
                saveBtn.disabled = false;
                saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                return;
            }

            const container = {
                containerNo: containerNo,
                size: document.getElementById('containerSize').value,
                type: document.getElementById('containerType').value,
                dateTimeIn: document.getElementById('dateTimeIn').value,
                freeDays: parseInt(document.getElementById('freeDays').value),
                notes: document.getElementById('notes').value,
                checkedOut: false,
                finalPrice: 0,
                createdAt: Date.now(),
                createdBy: currentUser
            };

            try {
                if (editingKey) {
                    await set(ref(database, `containers/${editingKey}`), container);
                } else {
                    const newRef = push(ref(database, 'containers'));
                    await set(newRef, container);
                }
                closeModal();
                saveBtn.disabled = false;
                saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                saveBtn.disabled = false;
                saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            }
        }

        function calculateDaysStored(dateTimeIn) {
            const start = new Date(dateTimeIn);
            const now = new Date();
            const diff = now - start;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function calculatePrice(container) {
            if (container.checkedOut) return container.finalPrice;
            const daysStored = calculateDaysStored(container.dateTimeIn);
            const chargeableDays = Math.max(0, daysStored - container.freeDays);
            let pricePerDay = container.size === '20' ? 30 : 50;
            return chargeableDays * pricePerDay;
        }

        function getStatus(container) {
            const daysStored = calculateDaysStored(container.dateTimeIn);
            const freeDaysLeft = container.freeDays - daysStored;
            if (freeDaysLeft > 0) return { text: 'üü¢ ‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö', class: 'status-free', value: 'free' };
            if (daysStored < 10) return { text: 'üü° ‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö', class: 'status-charging', value: 'charging' };
            return { text: 'üî¥ ‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ß‡∏±‡∏ô', class: 'status-overdue', value: 'overdue' };
        }

        function renderContainers() {
            const tbody = document.getElementById('containerTable');
            tbody.innerHTML = '';
            let displayContainers = filterContainersArray();

            displayContainers.forEach(([key, container]) => {
                const daysStored = calculateDaysStored(container.dateTimeIn);
                const freeDaysLeft = Math.max(0, container.freeDays - daysStored);
                const price = calculatePrice(container);
                const status = getStatus(container);
                const dateIn = new Date(container.dateTimeIn);
                const thaiMonths = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                const dateStr = `${dateIn.getDate()} ${thaiMonths[dateIn.getMonth()]} ${dateIn.getFullYear() + 543} ${dateIn.getHours().toString().padStart(2, '0')}:${dateIn.getMinutes().toString().padStart(2, '0')}`;
                const typeDisplay = container.type === 'R' ? '<span class="cold-indicator">‚ùÑÔ∏è ‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô</span>' : '‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${container.containerNo}</strong></td>
                    <td>${container.size} ‡∏ü‡∏∏‡∏ï${container.size.includes('R') ? ' <span class="cold-indicator">‚ùÑÔ∏è</span>' : ''}</td>
                    <td>${typeDisplay}</td>
                    <td>${dateStr}</td>
                    <td>${daysStored} ‡∏ß‡∏±‡∏ô</td>
                    <td>${freeDaysLeft} ‡∏ß‡∏±‡∏ô</td>
                    <td><strong>‡∏ø${price.toLocaleString()}</strong></td>
                    <td><span class="status-badge ${status.class}">${status.text}</span></td>
                    <td>${container.notes || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            ${!container.checkedOut ? 
                                `<button class="btn btn-success btn-small" onclick="checkOut('${key}')">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</button>` : 
                                '<span style="color: green; font-weight: bold;">‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß</span>'
                            }
                            <button class="btn btn-danger btn-small" onclick="deleteContainer('${key}')">‡∏•‡∏ö</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterContainersArray() {
            const search = document.getElementById('searchContainer').value.toUpperCase();
            const size = document.getElementById('filterSize').value;
            const type = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;

            return Object.entries(containers).filter(([key, container]) => {
                const matchSearch = !search || container.containerNo.includes(search);
                const matchSize = !size || container.size === size;
                const matchType = !type || container.type === type;
                const status = getStatus(container);
                const matchStatus = !statusFilter || status.value === statusFilter;
                return matchSearch && matchSize && matchType && matchStatus;
            });
        }

        function filterContainers() {
            renderContainers();
            updateStats();
        }

        function updateStats() {
            const allContainers = Object.values(containers);
            document.getElementById('totalContainers').textContent = allContainers.length;
            
            let freeCount = 0;
            let chargingCount = 0;
            let totalRevenue = 0;

            allContainers.forEach(container => {
                const status = getStatus(container);
                if (status.value === 'free') freeCount++;
                else chargingCount++;
                totalRevenue += calculatePrice(container);
            });

            document.getElementById('freeContainers').textContent = freeCount;
            document.getElementById('chargingContainers').textContent = chargingCount;
            document.getElementById('totalRevenue').textContent = `‡∏ø${totalRevenue.toLocaleString()}`;
        }

        async function checkOut(key) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ï‡∏π‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                const container = containers[key];
                const finalPrice = calculatePrice(container);
                container.checkedOut = true;
                container.finalPrice = finalPrice;
                container.checkOutDate = new Date().toISOString();
                
                try {
                    await set(ref(database, `containers/${key}`), container);
                    alert(`‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏°: ‡∏ø${finalPrice.toLocaleString()}`);
                } catch (error) {
                    console.error('Error:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå');
                }
            }
        }

        async function deleteContainer(key) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏π‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) {
                try {
                    await remove(ref(database, `containers/${key}`));
                    alert('‡∏•‡∏ö‡∏ï‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } catch (error) {
                    console.error('Error:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                }
            }
        }

        function exportToCSV() {
            const displayContainers = filterContainersArray();
            if (displayContainers.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }

            let csv = '‡πÄ‡∏•‡∏Ç‡∏ï‡∏π‡πâ,‡∏Ç‡∏ô‡∏≤‡∏î,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö,‡∏ü‡∏£‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠,‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏\n';

            displayContainers.forEach(([key, container]) => {
                const daysStored = calculateDaysStored(container.dateTimeIn);
                const freeDaysLeft = Math.max(0, container.freeDays - daysStored);
                const price = calculatePrice(container);
                const status = getStatus(container);
                const dateIn = new Date(container.dateTimeIn);
                const dateStr = dateIn.toLocaleString('th-TH');

                csv += `${container.containerNo},${container.size},${container.type},${dateStr},${daysStored},${freeDaysLeft},${price},${status.text},${container.notes || ''}\n`;
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `containers_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
